<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=80mm, initial-scale=1.0"/>
    <title>BOLETA DE VENTA</title>
    <style>
      @media print {
        body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; color-adjust: exact; }
        @page { size: 80mm auto; margin: 5mm 2.5mm 5mm 2.5mm; scale: 100; }
        #thermal-pos { width: 80mm !important; max-width: 80mm !important; margin: 0 !important; }
      }
      body { margin: 0; padding: 0; background: #fff; }
      #thermal-pos { font-family: Arial, sans-serif; max-width: 80mm; line-height: 4mm; }
      #thermal-pos h2 { font-size: 4mm; line-height: 13px; }
      #thermal-pos .label { text-align: center; font-size: 5mm; line-height: 1.3; }
      #thermal-pos .informasi { vertical-align: text-top; text-align: left; max-width: 45mm; word-wrap: break-word; }
      #thermal-pos .listitem { font-size: 4mm; text-align: center; }
      #thermal-pos table { width: 100%; table-layout: fixed; }
      #thermal-pos .item, #thermal-pos .amount, #thermal-pos .price, #thermal-pos .desc, #thermal-pos .qty, #thermal-pos .Isv { font-size: 4.2mm; }
      #thermal-pos .amount { text-align: right; }
      #thermal-pos .price, #thermal-pos .desc, #thermal-pos .qty, #thermal-pos .Isv { text-align: center; }
      #thermal-pos .detail { text-align: left; }
      #thermal-pos .detail1 { text-align: right; }
      #thermal-pos .descriptions { width: 100%; text-align: left; font-weight: bold; padding-top: 1px; padding-bottom: 1px; }
    </style>
  </head>
  <body>
    <div id="thermal-pos">
      <div class="label">
        <b>BODEGA GONZALES</b><br />
        <div class="label"><b>RTN: 18011993004982</b><br /></div>
        <div class="label">Direccion: Barrio Potreritos, 5ta calle frente a Casol<br /></div>
        <div class="label">Telefono: 9255-6823<br /></div>
        <div class="label">bodegagonzales77@gmail.com<br /></div>
      </div>
      <div align="center">--------------------------------------------------------</div>
      <div align="center" id="tipodoc"></div>
      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr><td class="informasi" style="width: 30%;">FOLIO:</td><td class="informasi" style="width: 70%;" id="folio"></td></tr>
        <tr><td class="informasi" style="width: 30%;">FECHA:</td><td class="informasi" style="width: 70%;" id="fecha"></td></tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div align="center">Datos del cliente</div>
      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr><td class="informasi" style="width: 30%;">Cliente:</td><td class="informasi" style="width: 70%;" id="cliente"></td></tr>
        <tr><td class="informasi" style="width: 30%;">RTN:</td><td class="informasi" style="width: 70%;" id="rtncliente"></td></tr>
        <tr><td class="informasi" style="width: 30%;">Direccion:</td><td class="informasi" style="width: 70%;" id="direccioncliente"></td></tr>
        <tr><td class="informasi" style="width: 30%;">Telefono:</td><td class="informasi" style="width: 70%;" id="telefonocliente"></td></tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div align="center">Detalle</div>
      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr class="listitem">
          <td><h2>Cant</h2></td>
          <td><h2>Precio</h2></td>
          <td><h2>Desc.</h2></td>
          <td><h2>Isv</h2></td>
          <td><h2>Monto</h2></td>
        </tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <table id="productTable"></table>
      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr><td class="detail">Total venta:</td><td class="detail1">L<span id="total"></span></td></tr>
        <tr><td class="detail">Pago Recibido:</td><td class="detail1">L<span id="recibido"></span></td></tr>
        <tr><td class="detail">Cambio:</td><td class="detail1">L<span id="cambio"></span></td></tr>
        <tr><td class="detail">Saldo:</td><td class="detail1">L<span id="saldo"></span></td></tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div id="montoLetras" style="text-align: center"></div>
      <div align="center">--------------------------------------------------------</div>
      <div align="center">Gracias por su preferencia!!</div>
      <div align="center">Original: Cliente, Copia: Emisor</div>
      <div align="center">--------------------------------------------------------</div>
    </div>
    <script>
      // URLs para consulta por nombre de hoja
      var opensheetUrlVentas = "https://opensheet.elk.sh/1IuaBvN--rdRk7vgKLv-x6sQpbko4jjygbTtq57jbohs/Ventas";
      var opensheetUrlVenta = "https://opensheet.elk.sh/1IuaBvN--rdRk7vgKLv-x6sQpbko4jjygbTtq57jbohs/Venta";

      function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }
      function formatCurrency(num) {
        num = parseFloat(num || 0);
        return num.toLocaleString('es-HN', {minimumFractionDigits:2, maximumFractionDigits:2});
      }
      function montoALetras(monto) {
        monto = parseFloat(monto || 0);
        const entero = Math.floor(monto);
        let decimales = Math.round((monto - entero) * 100);
        decimales = decimales < 10 ? "0" + decimales : decimales;
        return numALetras(entero) + " LEMPIRAS CON " + decimales + "/100";
      }
      function numALetras(num) {
        if (isNaN(num) || num === 0) return "CERO";
        let unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
        let decenas = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
        let especiales = {11: "ONCE", 12: "DOCE", 13: "TRECE", 14: "CATORCE", 15: "QUINCE"};
        let centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
        let resultado = "";
        if (num === 100) return "CIEN";
        if (num > 999999) return "NÃšMERO MUY GRANDE";
        let miles = Math.floor(num / 1000);
        let resto = num % 1000;
        if (miles > 0) {
          if (miles === 1) resultado += "MIL ";
          else resultado += numALetras(miles) + " MIL ";
        }
        if (resto > 0) {
          let centenasNum = Math.floor(resto / 100);
          let decenaUnida = resto % 100;
          let decenasNum = Math.floor(decenaUnida / 10);
          let unidadesNum = decenaUnida % 10;
          if (centenasNum > 0) resultado += centenas[centenasNum] + " ";
          if (decenaUnida >= 11 && decenaUnida <= 15) {
            resultado += especiales[decenaUnida] + " ";
          } else if (decenaUnida < 10) {
            resultado += unidades[decenaUnida] + " ";
          } else if (decenaUnida === 10) {
            resultado += "DIEZ ";
          } else if (decenaUnida === 20) {
            resultado += "VEINTE ";
          } else if (decenaUnida > 20 && decenaUnida < 30) {
            resultado += "VEINTI" + unidades[unidadesNum].toLowerCase() + " ";
          } else {
            resultado += decenas[decenasNum];
            if (unidadesNum > 0) resultado += " Y " + unidades[unidadesNum];
            resultado += " ";
          }
        }
        return resultado.trim();
      }

      async function main() {
        var no_venta = String(getQueryParam("no_venta")).trim();
        let ventas = [];
        let ventaDetalles = [];
        try {
          ventas = await fetch(opensheetUrlVentas).then(res => res.json());
        } catch(e) { ventas = []; }
        try {
          ventaDetalles = await fetch(opensheetUrlVenta).then(res => res.json());
        } catch(e) { ventaDetalles = []; }

        let v = ventas.find(row => String(row["No Venta"]).trim() === no_venta);
        let productos = ventaDetalles.filter(row => String(row["No Venta"]).trim() === no_venta);

        document.getElementById("tipodoc").textContent = v?.["Tipo"] || "VENTA";
        document.getElementById("folio").textContent = v?.["No Venta"] || no_venta;
        document.getElementById("fecha").textContent = v?.["Fecha"] || "";
        document.getElementById("cliente").textContent = v?.["NombreCliente"] || v?.["Cliente"] || "";
        document.getElementById("rtncliente").textContent = v?.["RTN"] || "";
        document.getElementById("direccioncliente").textContent = v?.["DireccionCliente"] || "";
        document.getElementById("telefonocliente").textContent = v?.["TelefonoCliente"] || "";

        document.getElementById("total").textContent = formatCurrency(v?.["Monto"] || v?.["Total"] || 0);
        document.getElementById("recibido").textContent = formatCurrency(v?.["Efectivo recibido"] || v?.["Abono"] || 0);
        document.getElementById("cambio").textContent = formatCurrency(v?.["Cambio"] || 0);
        document.getElementById("saldo").textContent = formatCurrency(v?.["Saldo"] || 0);

        var productTable = document.getElementById("productTable");
        productTable.innerHTML = "";
        productos.forEach(function(p) {
          let descripcion = p?.["Descripcion"] || p?.["Producto"] || "";
          let cantidad = formatCurrency(p?.["Cantidad"] || 0);
          let precio = formatCurrency(p?.["Precio"] || 0);
          let descprod = formatCurrency(p?.["Descuento Lps"] || p?.["Descuento %"] || 0);
          let isv = formatCurrency(p?.["Isv"] || p?.["Impuesto"] || 0);
          let monto = formatCurrency(p?.["Monto"] || 0);
          var descriptionRow = productTable.insertRow();
          descriptionRow.innerHTML = `<td colspan="5" class="descriptions">${descripcion}</td>`;
          var detailsRow = productTable.insertRow();
          detailsRow.innerHTML = `
            <td class="qty">${cantidad}</td>
            <td class="Price">${precio}</td>
            <td class="Desc">${descprod}</td>
            <td class="Isv">${isv}</td>
            <td class="Amount">${monto}</td>
          `;
          detailsRow.className = "listitem";
        });
        let totalMonto = v?.["Monto"] || v?.["Total"] || 0;
        document.getElementById("montoLetras").textContent = "SON " + montoALetras(totalMonto);
        setTimeout(()=>window.print(), 500);
      }
      window.onload = main;
    </script>
  </body>
</html>
