<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=80mm, initial-scale=1.0"/>
    <title>BOLETA DE VENTA</title>
    <style>
      @media print {
        body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; color-adjust: exact; }
        @page { size: 80mm auto; margin: 5mm 2.5mm 5mm 2.5mm; scale: 100; }
        #thermal-pos { width: 80mm !important; max-width: 80mm !important; margin: 0 !important; }
      }

      /* Base: aplica estilo compacto y consistente a la mayoría de líneas */
      body { margin: 0; padding: 0; background: #fff; }
      #thermal-pos {
        font-family: Arial, sans-serif;
        max-width: 80mm;
        line-height: 4mm;
        font-size: 11px; /* tamaño base: el detalle usa este tamaño para valores */
        color: #000;
      }

      /* Separator element that replaces dashed lines */
      .separator {
        width: 100%;
        height: 1px;
        background-color: rgba(0,0,0,0.12); /* subtle line */
        margin: 6px 0;
      }

      /* Encabezados, etiquetas y totales usan el mismo estilo base (sin negrita) */
      #thermal-pos .label { text-align: center; font-size: 12px; font-weight: normal; margin:0; padding:0; }
      #thermal-pos .informasi { vertical-align: text-top; text-align: left; word-wrap: break-word; font-size: 11px; }
      #thermal-pos .listitem { font-size: 11px; text-align: center; }

      #thermal-pos table { width: 100%; table-layout: fixed; border-collapse: collapse; }

      /* Column sizing for rectangular layout (description takes more width) */
      #thermal-pos .col-qty { width: 12%; text-align: left; padding: 0 4px; white-space: nowrap; font-size: 11px; }
      /* Descripción: AUMENTADA y en negrita SOLO para filas de descripción (.desc-row) */
      #thermal-pos .col-desc { width: 56%; text-align: left; word-break: break-word; white-space: normal; padding: 0 4px; font-size: 12px; }
      /* Precio y Monto: mantener mismo tamaño que demás valores (11px) */
      #thermal-pos .col-price { width: 16%; text-align: right; padding: 0 4px; white-space: nowrap; font-size: 11px; }
      #thermal-pos .col-amount { width: 16%; text-align: right; padding: 0 4px; white-space: nowrap; font-size: 11px; }

      /* Quitar negrita de encabezados del detalle */
      .header-row td h2 { margin:0; font-size: 12px; font-weight: normal; }

      #thermal-pos .descriptions { font-weight: normal; padding-top: 1px; padding-bottom: 1px; text-align:left; }
      #thermal-pos .detail { text-align: left; font-size: 11px; }
      #thermal-pos .detail1 { text-align: right; font-size: 11px; }

      /* Subtle separator line after each product entry */
      #productTable tr.product-row {
        border-bottom: 1px solid rgba(0,0,0,0.12);
      }
      /* Minimal vertical padding so ticket height doesn't expand */
      #productTable td { padding-top: 2px; padding-bottom: 2px; vertical-align: top; }
      /* Description row more compact */
      .desc-row td { padding-top: 2px; padding-bottom: 0; }

      /* Ensure long numbers don't overlap description */
      .col-price, .col-amount, .col-qty { overflow-wrap: anywhere; word-break: break-word; }

      /* Mantener qty + cualquier símbolo juntos */
      .qty-with-x { white-space: nowrap; }

      /* --- CHANGE: aumentar tamaño y poner en negrita SOLO las descripciones de producto --- */
      .desc-row .col-desc {
        font-size: 14px;   /* más grande para la descripción */
        font-weight: 700;  /* negrita solo en la descripción del producto */
        line-height: 1.1;
      }
      /* ------------------------------------------------------------------------------- */
    </style>
  </head>
  <body>
    <div id="thermal-pos">
      <div class="label">
        <b>BODEGA GONZALES</b><br />
        <div class="label">RTN: 18011993004982</div>
        <div class="label">Direccion: Barrio Potreritos, 5ta calle frente a Casol</div>
        <div class="label">Telefono: 9255-6823</div>
        <div class="label">bodegagonzales77@gmail.com</div>
      </div>

      <div class="separator"></div>
      <div align="center" id="tipodoc"></div>
      <div class="separator"></div>

      <table>
        <tr>
          <td class="informasi" style="width: 30%;">FOLIO:</td>
          <td class="informasi" style="width: 70%;" id="folio"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">FECHA:</td>
          <td class="informasi" style="width: 70%;" id="fecha"></td>
        </tr>
      </table>

      <div class="separator"></div>
      <div align="center">Datos del cliente</div>
      <div class="separator"></div>

      <table>
        <tr><td class="informasi" style="width: 30%;">Cliente:</td><td class="informasi" style="width: 70%;" id="cliente"></td></tr>
        <tr><td class="informasi" style="width: 30%;">RTN:</td><td class="informasi" style="width: 70%;" id="rtncliente"></td></tr>
        <tr><td class="informasi" style="width: 30%;">Direccion:</td><td class="informasi" style="width: 70%;" id="direccioncliente"></td></tr>
        <tr><td class="informasi" style="width: 30%;">Telefono:</td><td class="informasi" style="width: 70%;" id="telefonocliente"></td></tr>
      </table>

      <div class="separator"></div>
      <div align="center">Detalle</div>
      <div class="separator"></div>

      <!-- Encabezados: Cant, Descripción, Precio, Monto (sin negrita) -->
      <table>
        <tr class="listitem header-row">
          <td class="col-qty"><h2>Cant</h2></td>
          <td class="col-desc"><h2>Descripción</h2></td>
          <td class="col-price"><h2>Precio</h2></td>
          <td class="col-amount"><h2>Monto</h2></td>
        </tr>
      </table>

      <div class="separator"></div>
      <table id="productTable"></table>
      <div class="separator"></div>

      <table>
        <tr><td class="detail">Total venta:</td><td class="detail1">L<span id="total"></span></td></tr>
        <tr><td class="detail">Pago Recibido:</td><td class="detail1">L<span id="recibido"></span></td></tr>
        <tr><td class="detail">Cambio:</td><td class="detail1">L<span id="cambio"></span></td></tr>
        <tr><td class="detail">Saldo:</td><td class="detail1">L<span id="saldo"></span></td></tr>
      </table>

      <div class="separator"></div>
      <div id="montoLetras" style="text-align: center"></div>
      <div class="separator"></div>
      <div align="center">Gracias por su preferencia!!</div>
      <div align="center">Original: Cliente, Copia: Emisor</div>
      <div class="separator"></div>
    </div>

    <script>
      var opensheetUrlVentas = "https://opensheet.elk.sh/1IuaBvN--rdRk7vgKLv-x6sQpbko4jjygbTtq57jbohs/Ventas";
      var opensheetUrlVenta = "https://opensheet.elk.sh/1Jmr7ho8QtjYYvzyYJJX1rMw1P2xXXcmp9ti-iSuAgHI/Venta";

      function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }
      function formatCurrency(num) {
        num = parseFloat(num || 0);
        return num.toLocaleString('es-HN', {minimumFractionDigits:2, maximumFractionDigits:2});
      }
      function round0(num) {
        return Math.round(parseFloat(num || 0));
      }
      function formatCurrencyInt(num) {
        return round0(num).toLocaleString('es-HN', {minimumFractionDigits:0, maximumFractionDigits:0});
      }
      function montoALetras(monto) {
        monto = round0(monto || 0);
        return numALetras(monto) + " LEMPIRAS";
      }
      function numALetras(num) {
        if (isNaN(num) || num === 0) return "CERO";
        let unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
        let decenas = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
        let especiales = {11: "ONCE", 12: "DOCE", 13: "TRECE", 14: "CATORCE", 15: "QUINCE"};
        let centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
        let resultado = "";
        if (num === 100) return "CIEN";
        if (num > 999999) return "NÚMERO MUY GRANDE";
        let miles = Math.floor(num / 1000);
        let resto = num % 1000;
        if (miles > 0) {
          if (miles === 1) resultado += "MIL ";
          else resultado += numALetras(miles) + " MIL ";
        }
        if (resto > 0) {
          let centenasNum = Math.floor(resto / 100);
          let decenaUnida = resto % 100;
          let decenasNum = Math.floor(decenaUnida / 10);
          let unidadesNum = decenaUnida % 10;
          if (centenasNum > 0) resultado += centenas[centenasNum] + " ";
          if (decenaUnida >= 11 && decenaUnida <= 15) {
            resultado += especiales[decenaUnida] + " ";
          } else if (decenaUnida < 10) {
            resultado += unidades[decenaUnida] + " ";
          } else if (decenaUnida === 10) {
            resultado += "DIEZ ";
          } else if (decenaUnida === 20) {
            resultado += "VEINTE ";
          } else if (decenaUnida > 20 && decenaUnida < 30) {
            resultado += "VEINTI" + unidades[unidadesNum].toLowerCase() + " ";
          } else {
            resultado += decenas[decenasNum];
            if (unidadesNum > 0) resultado += " Y " + unidades[unidadesNum];
            resultado += " ";
          }
        }
        return resultado.trim();
      }
      function parseIsv(isv) {
        if (!isv) return 0;
        let v = String(isv).toUpperCase().trim();
        if (v === "0" || v === "EXENTO" || v === "NO" || v === "") return 0;
        if (v === "0.15" || v === "15%" || v === "15") return 0.15;
        if (v === "0.18" || v === "18%" || v === "18") return 0.18;
        let num = parseFloat(v.replace("%", ""));
        if (num === 15) return 0.15;
        if (num === 18) return 0.18;
        if (num === 0.15 || num === 0.18) return num;
        return 0;
      }
      function isLineaActiva(row) {
        if (!("Estado" in row)) return true;
        let estado = String(row["Estado"] || "").trim().toUpperCase();
        return estado === "ACTIVO";
      }

      async function main() {
        var no_venta = String(getQueryParam("no_venta")).trim();
        let ventas = [];
        let ventaDetalles = [];
        try {
          ventas = await fetch(opensheetUrlVentas).then(res => res.json());
        } catch(e) { ventas = []; }
        try {
          ventaDetalles = await fetch(opensheetUrlVenta).then(res => res.json());
        } catch(e) { ventaDetalles = []; }

        let v = ventas.find(row => String(row["No Venta"]).trim() === no_venta);

        let productos = ventaDetalles.filter(row =>
          String(row["No Venta"]).trim() === no_venta && isLineaActiva(row)
        );

        document.getElementById("folio").textContent = v?.["Fila"] || "";
        document.getElementById("fecha").textContent = v?.["Fecha"] || "";
        document.getElementById("tipodoc").textContent = v?.["Tipo"] || "VENTA";
        document.getElementById("cliente").textContent = v?.["NombreCliente"] || "";
        document.getElementById("rtncliente").textContent = v?.["RTN"] || "";
        document.getElementById("direccioncliente").textContent = v?.["DireccionCliente"] || "";
        document.getElementById("telefonocliente").textContent = v?.["TelefonoCliente"] || "";

        // Totales finales (redondeados a enteros)
        let totalVenta = round0(productos.reduce((sum, prod) =>
          sum + (parseFloat(prod["Monto"]) || 0), 0));

        let pagoRecibido = round0(parseFloat(v?.["Efectivo recibido"] || 0));
        let formaPago = (v?.["Forma de pago"] || "").trim();
        let tasa = parseFloat(v?.["Tasa"] || 0);
        let plazo = parseFloat(v?.["Plazo"] || 0);

        let interes = 0;
        if (formaPago.toLowerCase() === "credito") {
          interes = round0((totalVenta - pagoRecibido) * tasa * plazo);
        }

        let saldo = 0;
        if (pagoRecibido >= totalVenta) {
          saldo = 0;
        } else if (formaPago.toLowerCase() === "credito") {
          saldo = round0((totalVenta - pagoRecibido) + interes);
        } else {
          saldo = round0(totalVenta - pagoRecibido);
        }

        let cambio = 0;
        if (formaPago.toLowerCase() === "contado") {
          cambio = round0(pagoRecibido - totalVenta);
          if (cambio < 0) cambio = 0;
        }

        document.getElementById("total").textContent = formatCurrencyInt(totalVenta);
        document.getElementById("recibido").textContent = formatCurrencyInt(pagoRecibido);
        document.getElementById("cambio").textContent = cambio > 0 ? formatCurrencyInt(cambio) : "0";
        document.getElementById("saldo").textContent = formatCurrencyInt(saldo);

        var productTable = document.getElementById("productTable");
        productTable.innerHTML = "";

        productos.forEach(function(p) {
          let descripcion = p?.["Descripcion"] || p?.["Producto"] || "";
          let cantidad = parseFloat(p?.["Cantidad"] || 0);
          let precio = parseFloat(p?.["Precio"] || 0);

          // cálculo de descuento e impuesto (no mostrados en detalle)
          let descuentoUnitario = parseFloat(p?.["Descuento Lps"] || 0);
          let descuentoTotal = descuentoUnitario * cantidad;

          let isvPorc = parseIsv(p?.["Isv"]);
          let baseImponible = precio;
          if (isvPorc === 0.15) baseImponible = precio / 1.15;
          else if (isvPorc === 0.18) baseImponible = precio / 1.18;
          let impuestoUnitario = baseImponible * isvPorc;
          let impuestoTotal = impuestoUnitario * cantidad;

          let montoLinea = parseFloat(p?.["Monto"] || 0);

          // Fila 1: descripción (ocupa todo el ancho)
          var descRow = productTable.insertRow();
          descRow.className = "desc-row";
          descRow.innerHTML = `<td colspan="4" class="col-desc descriptions">${descripcion}</td>`;

          // Fila 2: cantidad en su columna, precio en su columna (sin "x"), monto al final
          var detailsRow = productTable.insertRow();
          detailsRow.className = "listitem product-row";
          detailsRow.innerHTML = `
            <td class="col-qty qty-with-x">${formatCurrency(cantidad)}</td>
            <td class="col-desc"></td>
            <td class="col-price">L${formatCurrency(precio)}</td>
            <td class="col-amount">L${formatCurrency(montoLinea)}</td>
          `;
        });

        let totalMonto = totalVenta;
        document.getElementById("montoLetras").textContent = "SON " + montoALetras(totalMonto);

        setTimeout(()=>window.print(), 500);
      }
      window.onload = main;
    </script>
  </body>
</html>
